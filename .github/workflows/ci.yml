name: Android CI/CD Pipeline

on:
  push:
    branches:
      - main         # Production releases on merge to main
  pull_request:
    branches:
      - develop      # Development branch
      - test         # Pre-production branch
      - main         # Production branch

# Cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Java version for Android build
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

  # Android Build Tools
  GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError"

jobs:
  # ============================================================================
  # Stage 1: Code Quality & Validation
  # ============================================================================
  code-quality:
    name: ðŸ” Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: â˜• Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ðŸ” Grant Execute Permission for Gradlew
        run: chmod +x gradlew

      - name: ðŸ“Š Run Lint Checks
        run: ./gradlew lint
        continue-on-error: true  # Don't fail build on lint errors (yet)

      - name: ðŸ“¤ Upload Lint Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: app/build/reports/lint-*.html
          retention-days: 30

      # Placeholder: Add detekt, ktlint, or other static analysis tools
      # - name: ðŸ”Ž Run Detekt
      #   run: ./gradlew detekt

      # Placeholder: Code coverage threshold check
      # - name: ðŸ“ˆ Check Code Coverage
      #   run: ./gradlew jacocoTestReport

  # ============================================================================
  # Stage 2: Build & Test
  # ============================================================================
  build-and-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: code-quality

    strategy:
      matrix:
        variant: [ Debug, Release ]

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ðŸ” Grant Execute Permission for Gradlew
        run: chmod +x gradlew

      - name: ðŸ—ï¸ Build ${{ matrix.variant }} APK
        run: ./gradlew assemble${{ matrix.variant }}

      - name: ðŸ§ª Run Unit Tests
        run: ./gradlew test${{ matrix.variant }}UnitTest

      - name: ðŸ“Š Generate Test Reports
        if: always()
        run: ./gradlew test${{ matrix.variant }}UnitTest --continue

      - name: ðŸ“¤ Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ matrix.variant }}
          path: |
            app/build/reports/tests/
            app/build/test-results/
          retention-days: 30

      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.variant }}-${{ github.sha }}
          path: app/build/outputs/apk/${{ matrix.variant }}/*.apk
          retention-days: 30

  # ============================================================================
  # Stage 3: Instrumented Tests (Placeholder)
  # ============================================================================
  instrumented-tests:
    name: ðŸ¤– Instrumented Tests
    runs-on: ubuntu-latest
    needs: build-and-test
    if: false  # Disabled by default - enable when ready

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # Placeholder: Setup Android Emulator
      # - name: ðŸ¤– Run Instrumented Tests
      #   uses: reactivecircus/android-emulator-runner@v2
      #   with:
      #     api-level: 34
      #     target: google_apis
      #     arch: x86_64
      #     script: ./gradlew connectedDebugAndroidTest

      - name: â„¹ï¸ Instrumented Tests Placeholder
        run: echo "Instrumented tests will be configured here"

  # ============================================================================
  # Stage 4: DEVELOP - Firebase App Distribution (Development)
  # ============================================================================
  deploy-develop:
    name: ðŸš€ Deploy to Development (Firebase)
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: development

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ðŸ” Grant Execute Permission for Gradlew
        run: chmod +x gradlew

      - name: ðŸ—ï¸ Build Debug APK
        run: ./gradlew assembleDebug

      # Placeholder: Firebase App Distribution
      - name: ðŸ”¥ Deploy to Firebase App Distribution (Development)
        if: false  # Enable when Firebase is configured
        # uses: wzieba/Firebase-Distribution-Github-Action@v1
        # with:
        #   appId: ${{ secrets.FIREBASE_APP_ID_DEV }}
        #   serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        #   groups: developers
        #   file: app/build/outputs/apk/debug/app-debug.apk
        #   releaseNotes: |
        #     Development Build
        #     Branch: ${{ github.ref_name }}
        #     Commit: ${{ github.sha }}
        run: |
          echo "ðŸ”¥ Firebase App Distribution for DEVELOP branch"
          echo "APK: app/build/outputs/apk/debug/app-debug.apk"
          echo "Configure Firebase App Distribution here"

      - name: ðŸ“¤ Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-develop
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 30

  # ============================================================================
  # Stage 5: TEST - Firebase App Distribution (Pre-Production)
  # ============================================================================
  deploy-test:
    name: ðŸ§ª Deploy to Pre-Production (Firebase)
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/test' && github.event_name == 'push'
    environment: pre-production

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ðŸ” Grant Execute Permission for Gradlew
        run: chmod +x gradlew

      # Placeholder: Decode signing keys
      # - name: ðŸ”‘ Decode Keystore
      #   run: |
      #     echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > app/keystore.jks

      - name: ðŸ—ï¸ Build Release APK (Unsigned for now)
        run: ./gradlew assembleRelease
        # Add signing configuration when ready:
        # env:
        #   KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        #   KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        #   KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      # Placeholder: Firebase App Distribution for Testers
      - name: ðŸ”¥ Deploy to Firebase App Distribution (Pre-Production)
        if: false  # Enable when Firebase is configured
        # uses: wzieba/Firebase-Distribution-Github-Action@v1
        # with:
        #   appId: ${{ secrets.FIREBASE_APP_ID_TEST }}
        #   serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        #   groups: testers,qa
        #   file: app/build/outputs/apk/release/app-release.apk
        #   releaseNotes: |
        #     Pre-Production Build
        #     Branch: ${{ github.ref_name }}
        #     Commit: ${{ github.sha }}
        run: |
          echo "ðŸ”¥ Firebase App Distribution for TEST branch"
          echo "APK: app/build/outputs/apk/release/app-release.apk"
          echo "Configure Firebase App Distribution for testers"

      - name: ðŸ“¤ Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-test
          path: app/build/outputs/apk/release/*.apk
          retention-days: 90

  # ============================================================================
  # Stage 6: MAIN - Production Release
  # ============================================================================
  deploy-production:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    permissions:
      contents: write  # Required for creating releases

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for release notes

      - name: â˜• Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ðŸ” Grant Execute Permission for Gradlew
        run: chmod +x gradlew

      # Placeholder: Decode signing keys for production
      # - name: ðŸ”‘ Decode Production Keystore
      #   run: |
      #     echo "${{ secrets.PROD_KEYSTORE_BASE64 }}" | base64 --decode > app/keystore.jks

      - name: ðŸ—ï¸ Build Production Release APK
        run: ./gradlew assembleRelease
        # Add production signing when ready:
        # env:
        #   KEYSTORE_PASSWORD: ${{ secrets.PROD_KEYSTORE_PASSWORD }}
        #   KEY_ALIAS: ${{ secrets.PROD_KEY_ALIAS }}
        #   KEY_PASSWORD: ${{ secrets.PROD_KEY_PASSWORD }}

      - name: ðŸ—ï¸ Build App Bundle (AAB)
        run: ./gradlew bundleRelease

      # Placeholder: Firebase App Distribution for Production
      - name: ðŸ”¥ Deploy to Firebase App Distribution (Production)
        if: false  # Enable when Firebase is configured
        # uses: wzieba/Firebase-Distribution-Github-Action@v1
        # with:
        #   appId: ${{ secrets.FIREBASE_APP_ID_PROD }}
        #   serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        #   groups: production-users
        #   file: app/build/outputs/apk/release/app-release.apk
        run: |
          echo "ðŸ”¥ Firebase App Distribution for PRODUCTION"
          echo "Configure production Firebase distribution"

      # Placeholder: Google Play Store Deployment
      - name: ðŸŽ® Deploy to Google Play Store (Internal Testing)
        if: false  # Enable when Play Console is configured
        # uses: r0adkll/upload-google-play@v1
        # with:
        #   serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
        #   packageName: com.kvrae.easykitchen
        #   releaseFiles: app/build/outputs/bundle/release/app-release.aab
        #   track: internal
        #   status: completed
        run: |
          echo "ðŸŽ® Google Play Store deployment placeholder"
          echo "Bundle: app/build/outputs/bundle/release/app-release.aab"
          echo "Configure Play Console API access"

      # Create GitHub Release
      - name: ðŸ“ Extract Version Name
        id: version
        run: |
          VERSION=$(grep "versionName" app/build.gradle.kts | grep -oP '"\K[^"]+')
          VERSION_CODE=$(grep "versionCode" app/build.gradle.kts | grep -oP '\d+')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION (Code: $VERSION_CODE)"

      - name: ðŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Easy Kitchen v${{ steps.version.outputs.version }}
          body: |
            ## ðŸ½ï¸ Easy Kitchen Release v${{ steps.version.outputs.version }}
            
            ### ðŸ“¦ Release Information
            - **Version Name:** ${{ steps.version.outputs.version }}
            - **Version Code:** ${{ steps.version.outputs.versionCode }}
            - **Build Date:** ${{ github.event.head_commit.timestamp }}
            - **Commit:** ${{ github.sha }}
            
            ### ðŸ“¥ Downloads
            - **APK:** Download the APK file below for direct installation
            - **AAB:** App Bundle for Play Store distribution
            
            ### ðŸ“ Changes
            ${{ github.event.head_commit.message }}
            
            ### â„¹ï¸ Installation Instructions
            1. Download the APK file
            2. Enable "Install from Unknown Sources" in your device settings
            3. Open the APK file to install
            
            ---
            Built with â¤ï¸ using GitHub Actions
          files: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“‹ Create Workflow Summary
        run: |
          echo "## ðŸŽ‰ Release Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Release Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Code:** ${{ steps.version.outputs.versionCode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Download APK](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/app-release.apk)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- APK: \`app-release.apk\`" >> $GITHUB_STEP_SUMMARY
          echo "- AAB: \`app-release.aab\`" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Upload Production Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-production-${{ github.sha }}
          path: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
          retention-days: 90  # Keep production builds for 90 days

  # ============================================================================
  # Stage 7: Notifications (Optional)
  # ============================================================================
  notify:
    name: ðŸ“¢ Send Notifications
    runs-on: ubuntu-latest
    needs: [ deploy-develop, deploy-test, deploy-production ]
    if: always() && (needs.deploy-develop.result != 'skipped' || needs.deploy-test.result != 'skipped' || needs.deploy-production.result != 'skipped')

    steps:
      - name: ðŸ“¢ Notification Placeholder
        run: |
          echo "ðŸ“¢ Notifications configuration placeholder"
          echo "Add Slack, Discord, Email, or other notifications here"

      # Placeholder: Slack Notification
      # - name: ðŸ“£ Send Slack Notification
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: 'Deployment completed for ${{ github.ref_name }}'
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      #   if: always()

